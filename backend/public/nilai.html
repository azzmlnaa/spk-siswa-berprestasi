<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Input Nilai | SPK Siswa Berprestasi</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
</head>
<body class="bg-gray-100 font-[Poppins] flex min-h-screen">

  <!-- Sidebar -->
  <aside class="w-64 bg-gray-900 text-gray-300 flex flex-col fixed h-full">
    <div class="text-center text-white text-xl font-semibold py-5 border-b border-gray-700">
      üßÆ SPK Siswa
    </div>
    <nav class="flex-1 p-4 space-y-2">
      <a href="index.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800">
        <i class="bi bi-house"></i> <span>Dashboard</span>
      </a>
      <a href="siswa.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800">
        <i class="bi bi-people"></i> <span>Kelola Siswa</span>
      </a>
      <a href="kriteria.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800">
        <i class="bi bi-list-check"></i> <span>Kelola Kriteria</span>
      </a>
      <a href="nilai.html" class="flex items-center gap-3 px-3 py-2 rounded-lg bg-blue-600 text-white">
        <i class="bi bi-pencil-square"></i> <span>Input Nilai</span>
      </a>
      <a href="hasil.html" class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-gray-800">
        <i class="bi bi-bar-chart"></i> <span>Hasil SPK</span>
      </a>
    </nav>
  </aside>

  <!-- Main -->
  <div class="flex-1 ml-64">
    <!-- Navbar -->
    <header class="bg-blue-600 text-white px-6 py-4 shadow flex items-center justify-between">
      <h1 class="text-lg font-semibold flex items-center gap-2">
        <i class="bi bi-pencil-square text-xl"></i> Input Nilai Siswa
      </h1>
      <a href="login.html">
        <button class="bg-blue-700 hover:bg-blue-800 px-4 py-1 rounded-lg text-sm">
          Logout
        </button>
      </a>
    </header>

    <!-- Content -->
    <main class="p-8 space-y-8">
      <!-- Tabel Siswa -->
      <section class="bg-white p-6 rounded-xl shadow">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">
          üìã Daftar Siswa
        </h2>
        <div class="overflow-x-auto">
          <table class="min-w-full border border-gray-200 text-sm">
            <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
              <tr>
                <th class="px-4 py-2 border">No</th>
                <th class="px-4 py-2 border">Nama Siswa</th>
                <th class="px-4 py-2 border">Kelas</th>
                <th class="px-4 py-2 border text-center">Aksi</th>
              </tr>
            </thead>
            <tbody id="tabelSiswa" class="text-gray-700 divide-y divide-gray-100"></tbody>
          </table>
        </div>
      </section>

      <!-- Form Input Nilai -->
      <section id="formNilaiSection" class="bg-white p-6 rounded-xl shadow hidden">
        <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">
          üßæ Input Nilai untuk <span id="namaSiswaLabel" class="text-blue-600"></span>
        </h2>

        <!-- Form Tambah Nilai -->
        <form id="formNilai" class="space-y-4">
          <input type="hidden" id="id_siswa" />
          <table class="min-w-full border border-gray-200 text-sm mb-4">
            <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
              <tr>
                <th class="px-4 py-2 border">No</th>
                <th class="px-4 py-2 border">Kriteria</th>
                <th class="px-4 py-2 border">Nilai (0‚Äì100)</th>
              </tr>
            </thead>
            <tbody id="tabelKriteria"></tbody>
          </table>

          <div class="text-right pt-2">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg shadow transition-all">
              <i class="bi bi-save"></i> Simpan Semua Nilai
            </button>
          </div>
        </form>

        <!-- Tabel Nilai yang sudah diinput -->
        <div class="mt-8">
          <h3 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">
            üìä Nilai yang Sudah Dimasukkan
          </h3>
          <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-200 text-sm">
              <thead class="bg-gray-50 text-gray-600 uppercase text-xs">
                <tr>
                  <th class="px-4 py-2 border">No</th>
                  <th class="px-4 py-2 border">Kriteria</th>
                  <th class="px-4 py-2 border">Nilai</th>
                  <th class="px-4 py-2 border text-center">Aksi</th>
                </tr>
              </thead>
              <tbody id="tabelNilai"></tbody>
            </table>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
  const baseURL = "http://localhost:5000/api";
  const token = localStorage.getItem("userToken");

  async function fetchJSON(url, options = {}) {
    const res = await fetch(url, options);
    const text = await res.text();
    let data;
    try {
      data = text ? JSON.parse(text) : {};
    } catch {
      throw new Error(`Response bukan JSON valid dari ${url}`);
    }
    if (!res.ok) throw new Error(data.message || `HTTP ${res.status}: ${res.statusText}`);
    return data;
  }

  // üîπ Load siswa
  async function loadSiswa() {
    const tbody = document.getElementById("tabelSiswa");
    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">‚è≥ Memuat data...</td></tr>`;
    try {
      const res = await fetchJSON(`${baseURL}/siswa`, {
        headers: { "Authorization": `Bearer ${token}` },
      });
      const siswa = Array.isArray(res) ? res : res.data || [];
      tbody.innerHTML = siswa.length
        ? siswa.map((s, i) => `
          <tr class="hover:bg-gray-50 text-center">
            <td class="border px-4 py-2">${i + 1}</td>
            <td class="border px-4 py-2 font-medium">${s.nama_siswa}</td>
            <td class="border px-4 py-2">${s.kelas || "-"}</td>
            <td class="border px-4 py-2">
              <button onclick="pilihSiswa(${s.id_siswa}, '${s.nama_siswa.replace(/'/g, "\\'")}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">
                <i class="bi bi-pencil"></i> Input Nilai
              </button>
            </td>
          </tr>`).join("")
        : `<tr><td colspan="4" class="text-center text-gray-500 py-4">Belum ada data siswa</td></tr>`;
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4">${err.message}</td></tr>`;
    }
  }

  // üîπ Ketika pilih siswa
  async function pilihSiswa(id, nama) {
    document.getElementById("id_siswa").value = id;
    document.getElementById("namaSiswaLabel").textContent = nama;
    document.getElementById("formNilaiSection").classList.remove("hidden");
    await loadKriteria();
    await loadNilai(id);
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  }

  // üîπ Load semua kriteria jadi tabel input
  async function loadKriteria() {
    const tbody = document.getElementById("tabelKriteria");
    tbody.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">‚è≥ Memuat kriteria...</td></tr>`;
    try {
      const res = await fetchJSON(`${baseURL}/kriteria`, {
        headers: { "Authorization": `Bearer ${token}` },
      });
      const data = Array.isArray(res) ? res : res.data || [];
      tbody.innerHTML = data.length
        ? data.map((k, i) => `
          <tr class="text-center">
            <td class="border px-4 py-2">${i + 1}</td>
            <td class="border px-4 py-2 text-left">${k.nama_kriteria}</td>
            <td class="border px-4 py-2">
              <input type="number" name="nilai_kriteria" data-id="${k.id_kriteria}"
                min="0" max="100"
                class="border border-gray-300 rounded-lg w-24 px-2 py-1 text-center focus:ring-2 focus:ring-blue-400 outline-none" />
            </td>
          </tr>`).join("")
        : `<tr><td colspan="3" class="text-center text-gray-500 py-4">Belum ada kriteria</td></tr>`;
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="3" class="text-center text-red-500 py-4">${err.message}</td></tr>`;
    }
  }

  // üîπ Simpan semua nilai baru
  document.getElementById("formNilai").addEventListener("submit", async (e) => {
    e.preventDefault();
    const id_siswa = document.getElementById("id_siswa").value;
    const inputs = document.querySelectorAll("input[name='nilai_kriteria']");
    const nilaiArray = Array.from(inputs)
      .map(input => ({
        id_kriteria: input.dataset.id,
        nilai: input.value.trim(),
      }))
      .filter(n => n.nilai !== "");

    if (nilaiArray.length === 0) {
      alert("‚ö†Ô∏è Isi minimal satu nilai sebelum menyimpan!");
      return;
    }

    try {
      for (const n of nilaiArray) {
        await fetch(`${baseURL}/nilai`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${token}`,
          },
          body: JSON.stringify({
            id_siswa,
            id_kriteria: n.id_kriteria,
            nilai: n.nilai,
          }),
        });
      }
      alert("‚úÖ Semua nilai berhasil disimpan!");
      await loadNilai(id_siswa);
    } catch (err) {
      alert("‚ùå Gagal menyimpan nilai: " + err.message);
    }
  });

  // üîπ Load nilai yang sudah ada
  async function loadNilai(id_siswa) {
    const tbody = document.getElementById("tabelNilai");
    tbody.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">‚è≥ Memuat nilai...</td></tr>`;
    try {
      const res = await fetchJSON(`${baseURL}/nilai/${id_siswa}`, {
        headers: { "Authorization": `Bearer ${token}` },
      });
      const data = res.data || [];
      tbody.innerHTML = data.length
        ? data.map((n, i) => `
          <tr class="text-center">
            <td class="border px-4 py-2">${i + 1}</td>
            <td class="border px-4 py-2">${n.nama_kriteria}</td>
            <td class="border px-4 py-2">${n.nilai}</td>
            <td class="border px-4 py-2">
              <button onclick="editNilai(${n.id_nilai}, ${n.nilai})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs"><i class="bi bi-pencil"></i> Edit</button>
              <button onclick="hapusNilai(${n.id_nilai})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs"><i class="bi bi-trash"></i> Hapus</button>
            </td>
          </tr>`).join("")
        : `<tr><td colspan="4" class="text-center text-gray-500 py-4">Belum ada nilai untuk siswa ini</td></tr>`;
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="4" class="text-center text-red-500 py-4">${err.message}</td></tr>`;
    }
  }

  // üîπ Edit nilai
  async function editNilai(id_nilai, nilaiLama) {
    const nilaiBaru = prompt("Masukkan nilai baru (0‚Äì100):", nilaiLama);
    if (nilaiBaru === null || nilaiBaru === "") return;
    try {
      await fetch(`${baseURL}/nilai/${id_nilai}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`,
        },
        body: JSON.stringify({ nilai: nilaiBaru }),
      });
      alert("‚úÖ Nilai berhasil diperbarui!");
      const id_siswa = document.getElementById("id_siswa").value;
      await loadNilai(id_siswa);
    } catch (err) {
      alert("‚ùå Gagal mengedit nilai: " + err.message);
    }
  }

  // üîπ Hapus nilai
  async function hapusNilai(id_nilai) {
    if (!confirm("Yakin ingin menghapus nilai ini?")) return;
    try {
      await fetch(`${baseURL}/nilai/${id_nilai}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` },
      });
      alert("üóëÔ∏è Nilai berhasil dihapus!");
      const id_siswa = document.getElementById("id_siswa").value;
      await loadNilai(id_siswa);
    } catch (err) {
      alert("‚ùå Gagal menghapus nilai: " + err.message);
    }
  }

  document.addEventListener("DOMContentLoaded", () => loadSiswa());
  </script>
</body>
</html>
